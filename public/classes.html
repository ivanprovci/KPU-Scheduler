<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a href="/"><img src="./images/logo.png" width="43" height="43" alt="kpu logo"></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup"
                aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-item nav-link text-white" href="/">Home</a>
                    <a class="nav-item nav-link text-white" href="semesters">Semesters</a>
                    <a class="nav-item nav-link text-white active" href="classes">Classes</a>
                    <a class="nav-item nav-link text-white" href="timetable">Timetable</a>
                    <a class="nav-item nav-link text-white" href="login">Login</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h2>Add Schedule Details</h2>
        <div id="semesterName" class="mb-3"></div>
        <form id="classForm">
            <input type="hidden" id="semesterId" name="semesterId" value="">
            <div id="classEntry" class="class-entry border p-3 mb-3">
                <div class="form-group">
                    <label for="CRN">CRN</label>
                    <input type="number" class="form-control" name="CRN" placeholder="Enter CRN" oninput="this.value = this.value.slice(0, 5)">
                </div>
                <div class="form-group">
                    <label for="Subject">Subject</label>
                    <select class="form-control" name="Subject">
                        <option>Select Subject</option>
                        <option>INFO</option>
                        <option>PHIL</option>
                        <option>BUQU</option>
                        <option>MATH</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="Class_Number">Class Number</label>
                    <input type="number" class="form-control" name="Class_Number" placeholder="Enter Class Number" oninput="this.value = this.value.slice(0, 4)">
                </div>
                <div class="form-group">
                    <label for="Section">Section</label>
                    <input type="text" class="form-control" name="Section" placeholder="Enter Section" oninput="this.value = this.value.slice(0, 3)">
                </div>
                <div class="form-group">
                    <label for="Campus">Campus</label>
                    <select class="form-control" name="Campus">
                        <option>Richmond</option>
                        <option>Surrey</option>
                        <option>Langley</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="Class_Size">Class Size</label>
                    <input type="number" class="form-control" name="Class_Size" placeholder="Enter Class Size" oninput="this.value = this.value.slice(0, 2)">
                </div>
                <div class="form-group">
                    <label for="Status">Status</label>
                    <select class="form-control" name="Status">
                        <option>Active</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="Instructional_Method">Instructional Method</label>
                    <select class="form-control" name="Instructional_Method">
                        <option>In-person</option>
                        <option>Online Synchronous</option>
                        <option>Blended Synchronous</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="Matrix_Code">Matrix Code</label>
                    <input type="text" class="form-control" name="Matrix_Code" placeholder="Enter Matrix Code" oninput="this.value = this.value.slice(0, 3)">
                </div>
                <div class="form-group">
                    <label for="Banner_Codes">Banner Codes</label>
                    <input type="text" class="form-control" name="Banner_Codes" placeholder="Enter Banner Codes" oninput="this.value = this.value.slice(0, 2)">
                </div>
                <div class="form-group">
                    <label for="Exam_Y_N">Exam Y/N</label>
                    <select class="form-control" name="Exam_Y_N">
                        <option>Y</option>
                        <option>N</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="Meeting_Type">Meeting Type</label>
                    <select class="form-control" name="Meeting_Type">
                        <option>Class</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="Session">Session</label>
                    <select class="form-control" name="Session">
                        <option>Full</option>
                        <option>Online</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="Non_Standard_Start_Date">Non-Standard Start Date</label>
                    <input type="date" class="form-control" name="Non_Standard_Start_Date">
                </div>
                <div class="form-group">
                    <label for="Non_Standard_End_Date">Non-Standard End Date</label>
                    <input type="date" class="form-control" name="Non_Standard_End_Date">
                </div>
                <div class="form-group">
                    <label for="Week_Day">Week Day</label>
                    <select class="form-control" name="Week_Day">
                        <option>Monday</option>
                        <option>Tuesday</option>
                        <option>Wednesday</option>
                        <option>Thursday</option>
                        <option>Friday</option>
                        <option>Saturday</option>
                        <option>Sunday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="Start_Time">Start Time</label>
                    <input type="time" class="form-control" name="Start_Time">
                </div>
                <div class="form-group">
                    <label for="End_Time">End Time</label>
                    <input type="time" class="form-control" name="End_Time">
                </div>
                <div class="form-group">
                    <label for="Exam_Date_Time">Exam Date & Time</label>
                    <input type="datetime-local" class="form-control" name="Exam_Date_Time">
                </div>
                <div class="form-group">
                    <label for="Room_Type">Room Type</label>
                    <input type="text" class="form-control" name="Room_Type" placeholder="Enter Room Type">
                </div>
                <div class="form-group">
                    <label for="Room_Preferences">Room Preferences</label>
                    <input type="text" class="form-control" name="Room_Preferences" placeholder="Enter Room Preferences">
                </div>
                <div class="form-group">
                    <label for="Instructor">Instructor</label>
                    <input type="text" class="form-control" name="Instructor" placeholder="Enter Instructor Name">
                </div>
            </div>
            <button type="button" class="btn btn-secondary mb-0" id="addClass">Add Another Class</button>
            <button type="submit" class="btn btn-primary" id="exportCSV">Export to CSV</button>
        </form>
        <div id="classesContainer"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const urlParams = new URLSearchParams(window.location.search);
                const semesterId = urlParams.get('semesterId');
                document.getElementById('semesterId').value = semesterId;
    
                const weekDayMap = {
                    'Monday': 'M',
                    'Tuesday': 'T',
                    'Wednesday': 'W',
                    'Thursday': 'R',
                    'Friday': 'F',
                    'Saturday': 'S',
                    'Sunday': 'U'
                };
    
                document.getElementById('addClass').addEventListener('click', function () {
                    const form = document.getElementById('classForm');
                    const formData = new FormData(form);
                    const classData = {};
    
                    formData.forEach((value, key) => {
                        if (key === 'Exam_Date_Time') {
                            classData[key] = new Date(value).toISOString();
                        } else {
                            classData[key] = value;
                        }
                    });
    
                    const weekDay = formData.get('Week_Day');
                    classData.Week_Day = weekDayMap[weekDay] || '';
    
                    if (Object.values(classData).every(x => x === "" || x === null)) {
                        alert("Please fill out all fields before adding another class.");
                        return;
                    }
    
                    fetch('/classes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(classData)
                    }).then(response => {
                        if (response.ok) {
                            alert("Class data saved successfully.");
                            form.reset();
                            document.getElementById('semesterId').value = semesterId;
                        } else {
                            response.json().then(data => {
                                alert(`Error saving class data: ${data.message}`);
                                console.error("Server error response:", data);
                            });
                        }
                    }).catch(error => {
                        alert("Error saving class data.");
                        console.error("Error in saveClassData:", error);
                    });
                });
    
                document.getElementById('classForm').addEventListener('submit', function (event) {
                    event.preventDefault();
                    const classEntries = document.querySelectorAll('.class-entry');
                    const headers = ["CRN", "Subject", "Class_Number", "Section", "Campus", "Class_Size", "Status", "Instructional_Method", "Matrix_Code", "Banner_Codes", "Exam_Y_N", "Meeting_Type", "Session", "Non_Standard_Start_Date", "Non_Standard_End_Date", "Week_Day", "Start_Time", "End_Time", "Exam_Date_Time", "Room_Type", "Room_Preferences", "Instructor"];
                    const rows = [headers.join(',')];
    
                    classEntries.forEach(entry => {
                        const crn = entry.querySelector('input[name="CRN"]').value;
                        const subject = entry.querySelector('select[name="Subject"]').value;
                        const classNumber = entry.querySelector('input[name="Class_Number"]').value;
                        const section = entry.querySelector('input[name="Section"]').value;
                        const campus = entry.querySelector('select[name="Campus"]').value;
                        const classSize = entry.querySelector('input[name="Class_Size"]').value;
                        const status = entry.querySelector('select[name="Status"]').value;
                        const instructionalMethod = entry.querySelector('select[name="Instructional_Method"]').value;
                        const matrixCode = entry.querySelector('input[name="Matrix_Code"]').value;
                        const bannerCodes = entry.querySelector('input[name="Banner_Codes"]').value;
                        const exam = entry.querySelector('select[name="Exam_Y_N"]').value;
                        const meetingType = entry.querySelector('select[name="Meeting_Type"]').value;
                        const session = entry.querySelector('select[name="Session"]').value;
                        const nonStartDate = entry.querySelector('input[name="Non_Standard_Start_Date"]').value;
                        const endDate = entry.querySelector('input[name="Non_Standard_End_Date"]').value;
                        const weekDay = weekDayMap[entry.querySelector('select[name="Week_Day"]').value] || '';
                        const startTime = entry.querySelector('input[name="Start_Time"]').value;
                        const endTime = entry.querySelector('input[name="End_Time"]').value;
                        const examDateTime = new Date(entry.querySelector('input[name="Exam_Date_Time"]').value).toISOString();
                        const roomType = entry.querySelector('input[name="Room_Type"]').value;
                        const roomPreferences = entry.querySelector('input[name="Room_Preferences"]').value;
                        const instructor = entry.querySelector('input[name="Instructor"]').value;
    
                        const row = [crn, subject, classNumber, section, campus, classSize, status, instructionalMethod, matrixCode, bannerCodes, exam, meetingType, session, nonStartDate, endDate, weekDay, startTime, endTime, examDateTime, roomType, roomPreferences, instructor].join(',');
                        rows.push(row);
                    });
    
                    const csvContent = "data:text/csv;charset=utf-8," + rows.join("\n");
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "classes_data.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            });
        </script>
    </body>
    </html>
